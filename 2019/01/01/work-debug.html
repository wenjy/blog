<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>工作中遇到的问题+踩过的坑 | 江湖义气的博客</title><meta property="og:title" content="工作中遇到的问题+踩过的坑 - 江湖义气的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2019-10-11T22:31:57+08:00"><meta property="article:modified_time" content="2019-10-11T22:31:57+08:00"><meta name=Keywords content="PHP,Swoole,Web开发,Golang,Linux,MySql,学习笔记"><meta name=description content="工作中遇到的问题+踩过的坑"><meta name=author content="江湖义气"><meta property="og:url" content="https://blog.wenjy.top/2019/01/01/work-debug.html"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://blog.wenjy.top>江湖义气的博客</a><p class=description>专注PHP开发。愿回首往事，不会因为虚度年华而悔恨，也不会因为碌碌无为而感到羞愧。</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://blog.wenjy.top>首页</a>
<a href=https://blog.wenjy.top/tools/ title=工具>工具</a>
<a href=https://blog.wenjy.top/archives/ title=归档>归档</a>
<a href=https://blog.wenjy.top/about/ title=关于>关于</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><style type=text/css>.post-toc{position:fixed;width:200px;margin-left:-210px;padding:5px 10px;font-family:Athelas,STHeiti,Microsoft Yahei,serif;font-size:12px;border:1px solid rgba(0,0,0,.07);border-radius:5px;background-color:rgba(255,255,255,.98);background-clip:padding-box;-webkit-box-shadow:1px 1px 2px rgba(0,0,0,.125);box-shadow:1px 1px 2px rgba(0,0,0,.125);word-wrap:break-word;white-space:nowrap;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:999;cursor:pointer;max-height:70%;overflow-y:auto;overflow-x:hidden}.post-toc .post-toc-title{width:100%;margin:0 auto;font-size:20px;font-weight:400;text-transform:uppercase;text-align:center}.post-toc .post-toc-content{font-size:15px}.post-toc .post-toc-content>nav>ul{margin:10px 0}.post-toc .post-toc-content ul{padding-left:20px;list-style:square;margin:.5em;line-height:1.8em}.post-toc .post-toc-content ul ul{padding-left:15px;display:none}@media print,screen and (max-width:1057px){.post-toc{display:none}}</style><div class=post-toc style=position:absolute;top:188px><h2 class=post-toc-title>文章目录</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#安装的虚拟机时间不同步>安装的虚拟机时间不同步</a></li><li><a href=#phpxdebug-运行失败端口繁忙>phpxdebug 运行失败，端口繁忙</a></li><li><a href=#本地测试环境curlhttps时因为没有设置公钥而失败>本地测试环境curl，https时因为没有设置公钥而失败</a></li><li><a href=#php函数long2ip溢出>PHP函数long2ip溢出</a></li><li><a href=#升级laravel框架>升级laravel框架</a></li><li><a href=#reids重启后rdb文件没有加载>reids重启后rdb文件没有加载</a></li><li><a href=#服务经常报502>服务经常报502</a></li><li><a href=#git换行符问题>git换行符问题</a></li><li><a href=#检测ip的延迟>检测ip的延迟</a></li><li><a href=#php-yar扩展报错>PHP yar扩展报错</a></li><li><a href=#laravel-http-status-419>laravel http status 419</a></li><li><a href=#redis-内存出了问题暂计>redis 内存出了问题(暂计)</a></li><li><a href=#laravel-迁移报错>laravel 迁移报错</a></li><li><a href=#cookie无法删除>cookie无法删除</a></li><li><a href=#gerrit-提交远程被拒绝>gerrit 提交远程被拒绝</a></li><li><a href=#phpunit-异常断言>phpunit 异常断言</a></li><li><a href=#composer-suggest>composer suggest</a></li><li><a href=#laravel-s-redis>laravel-s redis</a></li><li><a href=#swoole-yar-不兼容>swoole yar 不兼容</a></li><li><a href=#laravel-表单验证失败>laravel 表单验证失败</a></li><li><a href=#laravel-phpredisconnection-hscan-bug>laravel PhpRedisConnection hscan bug</a></li><li><a href=#数组参数签名前最好使用-ksort-排序>数组参数签名前，最好使用 ksort 排序</a></li><li><a href=#php-trait>php Trait</a></li><li><a href=#php可以为一个类提供一个静态方法实例化自己延迟绑定>PHP可以为一个类提供一个静态方法，实例化自己，延迟绑定</a></li><li><a href=#php-mockerymock>PHP Mockery::mock</a></li><li><a href=#2019711-小数精度问题>2019.7.11 小数精度问题</a></li><li><a href=#laravel-configcache-的问题>laravel config:cache 的问题</a><ul><li><a href=#php-mb_strlen>php mb_strlen</a></li></ul></li><li><a href=#laravel-phpredis-subscribe-因为使用了redis前缀-channel-返回时需要去掉前缀>laravel phpredis subscribe 因为使用了redis前缀 channel 返回时需要去掉前缀</a></li><li><a href=#php多进程编程pcntl-posix-event发现grpc扩展会导致进程无法-kill--15>php多进程编程，pcntl posix event，发现grpc扩展会导致进程无法 kill -15</a></li><li><a href=#php-apcu扩展需要开启-apcenable_cli-才能使用apcu_fetch之类的函数>php apcu扩展需要开启 apc.enable_cli 才能使用apcu_fetch之类的函数</a></li><li><a href=#php-composer---ignore-platform-reqs>php composer &ndash;ignore-platform-reqs</a></li><li><a href=#http-https-代理解析协议端口时-需要解析-connect-host-的端口>http https 代理解析协议端口时 需要解析 CONNECT HOST 的端口</a></li><li><a href=#php-apcu-ttl-在cli下不过期的问题需要设置apcuse_request_time0>php apcu ttl 在cli下不过期的问题，需要设置apc.use_request_time=0</a></li><li><a href=#reids-scan-命令在数据量比较少时例如count指定的返回偏差较大大数据集时count相差不大>reids scan 命令在数据量比较少时例如count指定的返回偏差较大，大数据集时count相差不大</a></li><li><a href=#下载文件可以使用-header-x-accel-redirect-来实现nginx层下载控制速度减少io>下载文件可以使用 header X-Accel-Redirect 来实现nginx层下载，控制速度，减少IO</a></li><li><a href=#wireshark卡死的原因居然是-有道词典的取词功能造成的>Wireshark卡死的原因居然是 有道词典的取词功能造成的</a></li><li><a href=#socket_set_option-参数顺序>socket_set_option 参数顺序</a></li><li><a href=#linux-tcp连接失败不回复synack问题>linux TCP连接失败(不回复SYN,ACK)问题</a></li></ul></nav></div></div><script type=text/javascript>$(document).ready(function(){var postToc=$(".post-toc");if(postToc.length){var leftPos=$("#main").offset().left;if(leftPos<220){postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})}
var t=postToc.offset().top-20,a={start:{position:"absolute",top:t},process:{position:"fixed",top:20},};$(window).scroll(function(){var e=$(window).scrollTop();e<t?postToc.css(a.start):postToc.css(a.process)})}})</script><article class=post><header><h1 class=post-title>工作中遇到的问题+踩过的坑</h1></header><date class="post-meta meta-date">2019年10月11日</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=https://blog.wenjy.top/categories/PHP>PHP</a></span></div><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><h2 id=安装的虚拟机时间不同步>安装的虚拟机时间不同步</h2><pre><code>ntpdate cn.pool.ntp.org
</code></pre><h2 id=phpxdebug-运行失败端口繁忙>phpxdebug 运行失败，端口繁忙</h2><pre><code>因为 phpxdebug 端口和 php 默认监听的端口冲突，都是默认9000，把 phpxdebug port 设置为其它端口，如9001
</code></pre><h2 id=本地测试环境curlhttps时因为没有设置公钥而失败>本地测试环境curl，https时因为没有设置公钥而失败</h2><p><a href=https://stackoverflow.com/questions/28858351/php-ssl-certificate-error-unable-to-get-local-issuer-certificate>设置公钥</a></p><h2 id=php函数long2ip溢出>PHP函数long2ip溢出</h2><pre><code>phpstudy 的PHP默认是32位的，long2ip() 时会有问题，需要换装64位的
reids 也是32位，溢出问题
直接替换 phpstudy 的 php 为 64位版本的，但是 redis 在win上没有，最后使用虚拟机了
</code></pre><h2 id=升级laravel框架>升级laravel框架</h2><pre><code>升级框架，laravel/lumen 5.6.* -&gt; 5.8.* 按照5.8.*修改composer.json依赖一致，然后利用gitbug的文件对比功能，修改改变的文件。
使用 github 版本文件对比，修改更改的文件和受影响的改动
</code></pre><p><a href=https://github.com/laravel/lumen/compare/5.6...master>Comparing changes</a></p><h2 id=reids重启后rdb文件没有加载>reids重启后rdb文件没有加载</h2><ul><li>原因 dir 设置的是 ./ 所以启动时没有到 rdb文件的目录导致没有加载，dir应设置为绝对目录 /usr/local/redis/</li></ul><h2 id=服务经常报502>服务经常报502</h2><ul><li>ip服务经常报502，但fpm进程并没跑满，后面查看nginx的错误日志发现有connect() to unix:/tmp/php7-cgi.sock failed (11: Resource temporarily unavailable) while connecting to upstream错误</li></ul><p><a href=https://www.cnxct.com/something-about-phpfpm-s-backlog/>backlog</a></p><h2 id=git换行符问题>git换行符问题</h2><ul><li>github clone 下一个项目，结果文件全是改动 eol unix expect windows</li></ul><p>git自动转换 CRLF
<a href=https://github.com/cssmagic/blog/issues/22>CRLF 问题</a></p><ul><li>locate 在centos软件包叫 mlocate 首次安装需要 updatedb</li></ul><h2 id=检测ip的延迟>检测ip的延迟</h2><ul><li>使用exce() 来ping 不安全，使用socket_create 构建ICMP ping 也需要特殊权限 suid</li></ul><p><a href=https://blog.lilydjwg.me/2013/10/29/non-privileged-icmp-ping.41390.html>不需要 root 权限的 ICMP ping</a></p><p>使用SOCK_DGRAM
<code>sudo sysctl -w net.ipv4.ping_group_range='0 10'</code> 设置用户组
<a href=https://www.jianshu.com/p/d77ede976bb3>不需要 root</a></p><p>最后还是使用 exce() 来ping，先验证IP合法性</p><h2 id=php-yar扩展报错>PHP yar扩展报错</h2><ul><li>本机yar 扩展打开了msgpack，服务器端没有支持</li></ul><p><a href=https://github.com/laruence/yar/issues/113>MSGPACK</a></p><ul><li>win上phpstudy php使用cgi，并且只有一个进程，代码里yar是循环调用</li></ul><p><a href=https://blessing.studio/phpstudy-prober-page-502-bad-gateway/>WSARecv() failed (10054: An existing connection was forcibly closed by the remote host)</a></p><h2 id=laravel-http-status-419>laravel http status 419</h2><p><code>laravel 419 Sorry, your session has expired. Please refresh and try again.</code></p><p>问题是没有加 csrf</p><p><a href=https://stackoverflow.com/questions/52583886/post-request-in-laravel-5-7-laravel-5-8-error-419-sorry-your-session-has/53781657#53781657>419</a></p><h2 id=redis-内存出了问题暂计>redis 内存出了问题(暂计)</h2><p><a href=https://blog.csdn.net/jiangshouzhuang/article/details/50864933>reids启动警告1</a></p><p><a href=https://www.jianshu.com/p/7ca4b74c92be>reids启动警告2</a></p><h2 id=laravel-迁移报错>laravel 迁移报错</h2><p>mysql5.6 字符集 utf8_mb4 varchar(255)
767/4=191 意思只能 varchar(191)</p><pre><code>SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; 
max key length is 767 bytes (SQL: alter table `jobs` add index `jobs_queue_index`(`queue`))
</code></pre><p><a href=https://stackoverflow.com/questions/1814532/1071-specified-key-was-too-long-max-key-length-is-767-bytes>error 1071</a></p><h2 id=cookie无法删除>cookie无法删除</h2><ul><li>使用 jquery.cookie removeCookie 无法删除cookie的问题</li></ul><p><a href=https://stackoverflow.com/questions/18486165/remove-cookie-using-jquery-not-working>需要指定path</a></p><h2 id=gerrit-提交远程被拒绝>gerrit 提交远程被拒绝</h2><p>原因是 <code>git config --global user.email "your_email@mail.com"</code>
我把全局的email修改了，phpstorm读取不到，commit 的时候自己填的email没有用，得选择phpstorm显示的才行</p><p>最后我修改回了公司的email，然后commit选择就能push了</p><h2 id=phpunit-异常断言>phpunit 异常断言</h2><ul><li>phpunit @expectedExceptionMessage 比较时使用的是 strpos</li></ul><h2 id=composer-suggest>composer suggest</h2><ul><li>Psr\Http\Message\ResponseInterface 编辑器找不到</li></ul><p>看了一下安装laravel时貌似没有安装 composer.json 里的 suggest 包，安装时并没有指定 &ndash;no-suggest: 跳过扩展包建议，看来是默认不安装的</p><h2 id=laravel-s-redis>laravel-s redis</h2><ul><li>laravel-s Redis::connection() 返回redis单例连接，每个 worker 进程只能保持一个连接，只有在max_request达到时
worker 将自动退出，进程退出后会释放所有内存和资源。</li></ul><h2 id=swoole-yar-不兼容>swoole yar 不兼容</h2><h2 id=laravel-表单验证失败>laravel 表单验证失败</h2><p>不是ajax请求会302，然后 redirect / 就会 404</p><ol><li>重写 App\Exceptions\Handler::render 同一验证失败json输出</li><li>也可以重写request header 因为是非ajax才会302</li></ol><h2 id=laravel-phpredisconnection-hscan-bug>laravel PhpRedisConnection hscan bug</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>    $it = null;
    $redis-&gt;setOption(\Redis::OPT_SCAN, \Redis::SCAN_RETRY);
    while($device_fds = $redis-&gt;client()-&gt;hScan(Link::getFdMapKey(), $it, &#39;&#39;, 1000)) {
        foreach($device_fds as $device_unique_mark =&gt; $fd) {
             echo $device_unique_mark . PHP_EOL;
        }
    }
</code></pre></td></tr></table></div></div><p>laravel框架封装的问题，需要调用$redis->client(),而不是直接使用phpredis，$it 需要引用，PhpRedisConnection 使用 __call 调用存在bug</p><h2 id=数组参数签名前最好使用-ksort-排序>数组参数签名前，最好使用 ksort 排序</h2><p>##laravel queue redis</p><p>因为设置了 &ndash;sleep=3 并且没有配置队列 block_for 导致队列延时执行
删除了 &ndash;sleep=3 并且配置 block_for => 3
block_for：将任务重新放入 Redis 数据库以及处理器轮询之前阻塞多久</p><h2 id=php-trait>php Trait</h2><p>定义了一个属性后，类就不能定义同样名称的属性，否则会产生 fatal error。 有种情况例外：属性是兼容的（同样的访问可见度、初始默认值）
可以先定义一个父类使用 Trait，然后子类就能覆写父类的属性了</p><h2 id=php可以为一个类提供一个静态方法实例化自己延迟绑定>PHP可以为一个类提供一个静态方法，实例化自己，延迟绑定</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php> public static function make($items = [])
 {
     return new static($items);
 }
</code></pre></td></tr></table></div></div><h2 id=php-mockerymock>PHP Mockery::mock</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>// 需先赋值
$request = Mockery::mock(CurlRequest::class);
// 这里不能连续调用，因为后面返回的不是 $request
$request-&gt;shouldReceive(&#39;post&#39;)
        -&gt;once()
        -&gt;andReturn([
            &#39;status&#39; =&gt; 1,
            &#39;msg&#39;    =&gt; &#39;请求成功&#39;
        ]);
</code></pre></td></tr></table></div></div><h2 id=2019711-小数精度问题>2019.7.11 小数精度问题</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>echo 16.33 * 100; // 1633
echo intval(16.33 * 100); // 1632
echo intval(strval(16.33 * 100)); // 1633
echo (int)(16.33 * 100); // 1632
</code></pre></td></tr></table></div></div><h2 id=laravel-configcache-的问题>laravel config:cache 的问题</h2><p>如果在部署过程中执行 config:cache 命令，那你应该确保只从配置文件内部调用 env 函数。一旦配置被缓存，.env 文件将不再被加载，所有对 env 函数的调用都将返回 null</p><h3 id=php-mb_strlen>php mb_strlen</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>echo mb_strlen(&#39;测试&#39;); // 2 默认编码UTF-8
mb_strlen(&#39;测试&#39;, &#39;UTF-8&#39;); // 2
mb_strlen(&#39;测试&#39;, &#39;8bit&#39;); // 6
strlen(&#39;测试&#39;); // 6
// 8bit是php独有解析的, 8bit并不是一个字符集, 只是php引擎可以解析它而已. 顾名思义, 一个字节等于八个位, 1byte=8bit
</code></pre></td></tr></table></div></div><p>PHP支持mbstring.func_overload, 用于解决原生substr无法有效应对多字节编码字符串问题
启用时php runtime状态是未知的， 所以在计算字符长度时， 用mb_strlen 8bit来保证计算字符串长度的正确性（按照1byte = 8bit）</p><p>##PHP 一个if判断变量的速度问题，类型转换</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>$array = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

$start = microtime(true);
for ($i = 0; $i &lt; <span style=color:navy>1000000</span><span style=color:#a61717;background-color:#e3d2d2>;</span> <span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:teal>i</span><span style=color:#a61717;background-color:#e3d2d2>++)</span> <span style=color:#a61717;background-color:#e3d2d2>{</span>
<span style=color:#a61717;background-color:#e3d2d2>//</span>    <span style=color:teal>if</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:teal>count</span><span style=color:#a61717;background-color:#e3d2d2>($</span><span style=color:teal>array</span><span style=color:#a61717;background-color:#e3d2d2>))</span> <span style=color:#a61717;background-color:#e3d2d2>{}</span> <span style=color:#a61717;background-color:#e3d2d2>//</span> <span style=color:teal>0</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:teal>01805305480957</span>
<span style=color:#a61717;background-color:#e3d2d2>//</span>    <span style=color:teal>if</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:teal>is_null</span><span style=color:#a61717;background-color:#e3d2d2>($</span><span style=color:teal>array</span><span style=color:#a61717;background-color:#e3d2d2>))</span> <span style=color:#a61717;background-color:#e3d2d2>{}</span> <span style=color:#a61717;background-color:#e3d2d2>//</span> <span style=color:teal>0</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:teal>013534784317017</span>
<span style=color:#a61717;background-color:#e3d2d2>//</span>    <span style=color:teal>if</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:teal>empty</span><span style=color:#a61717;background-color:#e3d2d2>($</span><span style=color:teal>array</span><span style=color:#a61717;background-color:#e3d2d2>))</span> <span style=color:#a61717;background-color:#e3d2d2>{}</span> <span style=color:#a61717;background-color:#e3d2d2>//</span> <span style=color:teal>0</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:teal>014011859893799</span>
    <span style=color:teal>if</span> <span style=color:#a61717;background-color:#e3d2d2>(!$</span><span style=color:teal>array</span><span style=color:#a61717;background-color:#e3d2d2>)</span> <span style=color:#a61717;background-color:#e3d2d2>{}</span> <span style=color:#a61717;background-color:#e3d2d2>//</span> <span style=color:teal>0</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:teal>016890048980713</span>
<span style=color:#a61717;background-color:#e3d2d2>}</span>
<span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:teal>end </span><span style=color:#000;font-weight:700>=</span> <span style=color:#d14>microtime(true);</span>
<span style=color:teal>echo</span> <span style=color:#a61717;background-color:#e3d2d2>&#34;</span><span style=color:teal>1:</span> <span style=color:#a61717;background-color:#e3d2d2>&#34;</span> <span style=color:#a61717;background-color:#e3d2d2>.</span> <span style=color:#a61717;background-color:#e3d2d2>($</span><span style=color:teal>end</span> <span style=color:teal>-</span> <span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:teal>start</span><span style=color:#a61717;background-color:#e3d2d2>)</span> <span style=color:#a61717;background-color:#e3d2d2>.</span> <span style=color:#a61717;background-color:#e3d2d2>&#34;\</span><span style=color:teal>n</span><span style=color:#a61717;background-color:#e3d2d2>&#34;;</span>
<span style=color:teal>echo</span> <span style=color:teal>memory_get_usage</span><span style=color:#a61717;background-color:#e3d2d2>()</span> <span style=color:#a61717;background-color:#e3d2d2>.</span> <span style=color:#a61717;background-color:#e3d2d2>&#34;\</span><span style=color:teal>n</span><span style=color:#a61717;background-color:#e3d2d2>&#34;;</span> <span style=color:#a61717;background-color:#e3d2d2>//</span> <span style=color:teal>389032</span>
</code></pre></td></tr></table></div></div><h2 id=laravel-phpredis-subscribe-因为使用了redis前缀-channel-返回时需要去掉前缀>laravel phpredis subscribe 因为使用了redis前缀 channel 返回时需要去掉前缀</h2><h2 id=php多进程编程pcntl-posix-event发现grpc扩展会导致进程无法-kill--15>php多进程编程，pcntl posix event，发现grpc扩展会导致进程无法 kill -15</h2><h2 id=php-apcu扩展需要开启-apcenable_cli-才能使用apcu_fetch之类的函数>php apcu扩展需要开启 apc.enable_cli 才能使用apcu_fetch之类的函数</h2><h2 id=php-composer---ignore-platform-reqs>php composer &ndash;ignore-platform-reqs</h2><p>可忽略平台约束 例如win下升级 而composer.json require 一些win没有的扩展</p><h2 id=http-https-代理解析协议端口时-需要解析-connect-host-的端口>http https 代理解析协议端口时 需要解析 CONNECT HOST 的端口</h2><h2 id=php-apcu-ttl-在cli下不过期的问题需要设置apcuse_request_time0>php apcu ttl 在cli下不过期的问题，需要设置apc.use_request_time=0</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>// cli 下运行
$bar = date(&#39;Y-m-d H:i:s&#39;);
var_dump(apcu_store(&#39;foo&#39;, $bar, 3));
sleep(4);
var_dump(apcu_fetch(&#39;foo&#39;));
// apc.use_request_time=1 不过期
// 使用请求时间来淘汰缓存
</code></pre></td></tr></table></div></div><h2 id=reids-scan-命令在数据量比较少时例如count指定的返回偏差较大大数据集时count相差不大>reids scan 命令在数据量比较少时例如count指定的返回偏差较大，大数据集时count相差不大</h2><p>可使用yield遍历整个数据集</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>$key = &#39;test_set_111222&#39;;
$items = [];
for ($i = 0; $i &lt; <span style=color:navy>1000</span><span style=color:#a61717;background-color:#e3d2d2>;</span> <span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:teal>i</span><span style=color:#a61717;background-color:#e3d2d2>++)</span> <span style=color:#a61717;background-color:#e3d2d2>{</span>
    <span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:teal>items</span><span style=color:#a61717;background-color:#e3d2d2>[]</span> <span style=color:#a61717;background-color:#e3d2d2>=</span> <span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:teal>i</span><span style=color:#a61717;background-color:#e3d2d2>;</span>
<span style=color:#a61717;background-color:#e3d2d2>}</span>
<span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:teal>this-</span>&gt;redis-&gt;sAdd($key, ...$items);
foreach ($this-&gt;get($key, 20) as $item) {
    var_dump($item);
}
function get($key, int $count) : Generator
{
    $this-&gt;redis-&gt;setOption(\Redis::OPT_SCAN, \Redis::SCAN_RETRY);
    $it = null;
    while ($item = $this-&gt;redis-&gt;client()-&gt;sScan($key, $it, &#39;*&#39;, $count)) {
        yield $item;
    }
}
</code></pre></td></tr></table></div></div><h2 id=下载文件可以使用-header-x-accel-redirect-来实现nginx层下载控制速度减少io>下载文件可以使用 header X-Accel-Redirect 来实现nginx层下载，控制速度，减少IO</h2><h2 id=wireshark卡死的原因居然是-有道词典的取词功能造成的>Wireshark卡死的原因居然是 有道词典的取词功能造成的</h2><p><a href=https://segmentfault.com/a/1190000019913529>wireshark为什么会卡死？</a></p><h2 id=socket_set_option-参数顺序>socket_set_option 参数顺序</h2><p>SO_REUSEPORT 必须在 bind() 函数之前设置</p><h2 id=linux-tcp连接失败不回复synack问题>linux TCP连接失败(不回复SYN,ACK)问题</h2><p><a href=https://blog.csdn.net/ywq935/article/details/91384854>参考分析问题1</a></p><p><a href=https://www.cnblogs.com/cheyunhua/p/9082674.html>net.ipv4.tcp_tw_recycle参数</a></p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://blog.wenjy.top>江湖义气</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://blog.wenjy.top/2019/01/01/work-debug.html>https://blog.wenjy.top/2019/01/01/work-debug.html</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/2018/10/01/design-patten-readme.html>设计模式-学习《大话设计模式》的整理</a></li><li><a href=/2017/12/20/php-spl-iterators.html>PHP Spl Iterators</a></li><li><a href=/2017/12/20/php-spl-datastructures.html>PHP Spl Datastructures</a></li><li><a href=/about/>关于我</a></li><li><a href=/archives/>归档</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=https://blog.wenjy.top/tags/PHP>PHP</a></li></ul></div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=wenjy/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></div><div id=secondary><section class=widget><form id=search action=https://blog.wenjy.top/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://blog.wenjy.top>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://blog.wenjy.top/2020/04/14/markdown.html title=Markdown语法>Markdown语法</a></li><li><a href=https://blog.wenjy.top/2020/04/14/regexp.html title=正则表达式>正则表达式</a></li><li><a href=https://blog.wenjy.top/2020/04/02/tcp-connect-close.html title="TCP 三次握手 四次挥手">TCP 三次握手 四次挥手</a></li><li><a href=https://blog.wenjy.top/2020/04/01/http-response-status-codes.html title="HTTP 响应状态码">HTTP 响应状态码</a></li><li><a href=https://blog.wenjy.top/2020/03/29/linux-file-permission.html title=Linux文件目录权限>Linux文件目录权限</a></li><li><a href=https://blog.wenjy.top/2020/03/26/git-command.html title="Git 常用命令">Git 常用命令</a></li><li><a href=https://blog.wenjy.top/2020/03/26/linux-command.html title="Linux 常用命令">Linux 常用命令</a></li><li><a href=https://blog.wenjy.top/2019/01/01/work-debug.html title=工作中遇到的问题+踩过的坑>工作中遇到的问题+踩过的坑</a></li><li><a href=https://blog.wenjy.top/2019/10/11/mysql-index-optimize.html title="Mysql 索引学习">Mysql 索引学习</a></li><li><a href=https://blog.wenjy.top/2019/10/11/linux-lock-principle.html title="Linux Lock的原理">Linux Lock的原理</a></li></ul></section><section class=widget><h3 class=widget-title style=color:red>福利派送</h3><ul class=widget-list><li><a href target=_blank style=color:red></a></li></ul></section><section class=widget><h3 class=widget-title>分类</h3><ul class=widget-list><li><a href=https://blog.wenjy.top/categories/Algorithms/>Algorithms (9)</a></li><li><a href=https://blog.wenjy.top/categories/DesignPatten/>DesignPatten (25)</a></li><li><a href=https://blog.wenjy.top/categories/Git/>Git (1)</a></li><li><a href=https://blog.wenjy.top/categories/Http/>Http (1)</a></li><li><a href=https://blog.wenjy.top/categories/Linux/>Linux (3)</a></li><li><a href=https://blog.wenjy.top/categories/Markdown/>Markdown (1)</a></li><li><a href=https://blog.wenjy.top/categories/MySQL/>MySQL (1)</a></li><li><a href=https://blog.wenjy.top/categories/PHP/>PHP (38)</a></li><li><a href=https://blog.wenjy.top/categories/Regexp/>Regexp (1)</a></li><li><a href=https://blog.wenjy.top/categories/TCP/>TCP (1)</a></li></ul></section><section class=widget><h3 class=widget-title>标签</h3><div class=tagcloud><a href=https://blog.wenjy.top/tags/Algorithms/>Algorithms</a>
<a href=https://blog.wenjy.top/tags/DesignPatten/>DesignPatten</a>
<a href=https://blog.wenjy.top/tags/Git/>Git</a>
<a href=https://blog.wenjy.top/tags/Http/>Http</a>
<a href=https://blog.wenjy.top/tags/Linux/>Linux</a>
<a href=https://blog.wenjy.top/tags/Markdown/>Markdown</a>
<a href=https://blog.wenjy.top/tags/MySQL/>MySQL</a>
<a href=https://blog.wenjy.top/tags/PHP/>PHP</a>
<a href=https://blog.wenjy.top/tags/Regexp/>Regexp</a>
<a href=https://blog.wenjy.top/tags/TCP/>TCP</a></div></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://mikelin.cn title="MIKELIN | 关注科技，弘扬互联网精神！">MIKELIN</a></li><li><a target=_blank href=https://blog.wenjy.top title=江湖义气的网络日志>江湖义气的网络日志</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://blog.wenjy.top/index.xml>文章 RSS</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href=https://blog.wenjy.top>江湖义气的博客 By 江湖义气</a>.
Powered by <a rel="nofollow noreferer noopener" href=https://gohugo.io target=_blank>Hugo</a>.
<a href=https://www.flysnow.org/ target=_blank>Theme</a> based on <a href=https://github.com/flysnow-org/maupassant-hugo target=_blank>maupassant</a>.
备案号：<a href=http://www.beian.miit.gov.cn target=_blank>桂ICP备17000652号-2</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src="/js/totop.js?v=0.0.0" async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-161796130-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script></body></html>