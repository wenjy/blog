<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=generator content="Hugo 0.58.3"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Work | Wenjy&#39;s Blog</title><meta property=og:title content="Work - Wenjy's Blog"><meta property=og:type content=article><meta property=article:published_time content=2019-10-11T22:31:57&#43;08:00><meta property=article:modified_time content=2019-10-11T22:31:57&#43;08:00><meta name=Keywords content=PHP,Swoole,Web开发><meta name=description content=Work><meta name=author content=江湖义气><meta property=og:url content=https://wenjy.top/work/><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://wenjy.top>Wenjy&#39;s Blog</a><p class=description>回首往事，不会因为虚度年华而悔恨，也不会因为碌碌无为而感到羞愧。</p></div><div><nav id=nav-menu class=clearfix><a href=https://wenjy.top>首页</a>
<a href=https://wenjy.top/archives title=归档>归档</a>
<a href=https://wenjy.top/about title=关于>关于</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Work</h1></header><date class="post-meta meta-date">2019年10月11日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span> 阅读</span></span></div><div class=post-content><h2 id=工作中遇到的问题-踩过的坑>工作中遇到的问题+踩过的坑</h2><h4 id=2019-4-10>2019.4.10</h4><ul><li>安装的虚拟机时间不同步
ntpdate cn.pool.ntp.org</li></ul><h4 id=2019-4-11>2019.4.11</h4><ul><li>phpxdebug 运行失败，端口繁忙</li></ul><p>因为 phpxdebug 端口和 php 默认监听的端口冲突，都是默认9000</p><p>把 phpxdebug port 设置为 9001</p><ul><li>本地测试环境curl，https时因为没有设置公钥而失败
<a href=https://stackoverflow.com/questions/28858351/php-ssl-certificate-error-unable-to-get-local-issuer-certificate>设置</a></li></ul><h4 id=2019-4-15>2019.4.15</h4><ul><li>yar Yar_Client 报错：curl exec failed &lsquo;Timeout was reached&rsquo;</li></ul><h4 id=2019-4-16>2019.4.16</h4><ul><li>phpstudy 的PHP默认是32位的，long2ip() 时会有问题，需要换装64位的</li><li>reids 也是32位，溢出问题</li></ul><p>直接替换 phpstudy 的 php 为 64位版本的，但是 redis 在win上没有，最后使用虚拟机了</p><h4 id=2019-4-17>2019.4.17</h4><ul><li>升级框架，laravel/lumen 5.6.* -&gt; 5.8.* 按照5.8.*修改composer.json依赖一致，然后利用gitbug的文件对比功能，修改改变的文件。</li></ul><p>使用 github 版本文件对比，修改更改的文件和受影响的改动</p><p><a href=https://github.com/laravel/lumen/compare/5.6...master>Comparing changes</a></p><h4 id=2019-4-18>2019.4.18</h4><ul><li><p>reids重启后rdb文件没有加载，原因 dir 设置的是 ./ 所以启动时没有到 rdb文件的目录导致没有加载，dir应设置为绝对目录 /usr/local/redis/</p></li><li><p>ip服务经常报502，但fpm进程并没跑满，后面查看nginx的错误日志发现有connect() to unix:/tmp/php7-cgi.sock failed (11: Resource temporarily unavailable) while connecting to upstream错误</p></li></ul><p><a href=https://www.cnxct.com/something-about-phpfpm-s-backlog/>backlog</a></p><h4 id=2019-4-25>2019.4.25</h4><ul><li>github clone 下一个项目，结果文件全是改动 eol unix expect windows</li></ul><p>git自动转换 CRLF
<a href=https://github.com/cssmagic/blog/issues/22>CRLF 问题</a></p><ul><li>locate 在centos软件包叫 mlocate 首次安装需要 updatedb</li></ul><h4 id=2019-4-28>2019.4.28</h4><ul><li>检测ip的延迟，使用exce() 来ping 不安全，使用socket_create 构建ICMP ping 也需要特殊权限 suid</li></ul><p><a href=https://blog.lilydjwg.me/2013/10/29/non-privileged-icmp-ping.41390.html>不需要 root 权限的 ICMP ping</a></p><p>使用SOCK_DGRAM
<code>sudo sysctl -w net.ipv4.ping_group_range='0 10'</code> 设置用户组
<a href=https://www.jianshu.com/p/d77ede976bb3>不需要 root</a></p><p>最后还是使用 exce() 来ping，先验证IP合法性</p><h4 id=2019-5-8>2019.5.8</h4><ul><li>本机yar 扩展打开了msgpack，服务器端没有支持</li></ul><p><a href=https://github.com/laruence/yar/issues/113>MSGPACK</a></p><ul><li>win上phpstudy php使用cgi，并且只有一个进程，代码里yar是循环调用</li></ul><p><a href=https://blessing.studio/phpstudy-prober-page-502-bad-gateway/>WSARecv() failed (10054: An existing connection was forcibly closed by the remote host)</a></p><h4 id=2019-5-14>2019.5.14</h4><ul><li>laravel 419 Sorry, your session has expired. Please refresh and try again.</li></ul><p>问题是没有加 csrf</p><p><a href=https://stackoverflow.com/questions/52583886/post-request-in-laravel-5-7-laravel-5-8-error-419-sorry-your-session-has/53781657#53781657>419</a></p><ul><li>redis 内存出了问题(暂计)</li></ul><p><a href=https://blog.csdn.net/jiangshouzhuang/article/details/50864933>reids启动警告1</a>
<a href=https://www.jianshu.com/p/7ca4b74c92be>reids启动警告2</a></p><h4 id=2019-5-21>2019.5.21</h4><ul><li>laravel 迁移报错</li></ul><p>mysql5.6 字符集 utf8_mb4 varchar(255)
<sup>767</sup>&frasl;<sub>4</sub>=191 意思只能 varchar(191)
SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes (SQL: alter table <code>jobs</code> add index <code>jobs_queue_index</code>(<code>queue</code>))</p><p><a href=https://stackoverflow.com/questions/1814532/1071-specified-key-was-too-long-max-key-length-is-767-bytes>error 1071</a></p><h4 id=2019-5-22>2019.5.22</h4><ul><li>使用 jquery.cookie removeCookie 无法删除cookie的问题</li></ul><p><a href=https://stackoverflow.com/questions/18486165/remove-cookie-using-jquery-not-working>需要指定path</a></p><h4 id=2019-5-23>2019.5.23</h4><ul><li>gerrit 提交远程被拒绝</li></ul><p>原因是 <code>git config --global user.email &quot;your_email@mail.com&quot;</code>
我把全局的email修改了，phpstorm读取不到，commit 的时候自己填的email没有用，得选择phpstorm显示的才行</p><p>最后我修改回了公司的email，然后commit选择就能push了</p><h4 id=2019-5-31>2019.5.31</h4><ul><li>phpunit @expectedExceptionMessage 比较时使用的是 strpos</li></ul><h4 id=2019-6-1>2019.6.1</h4><ul><li>Psr\Http\Message\ResponseInterface 编辑器找不到</li></ul><p>看了一下安装laravel时貌似没有安装 composer.json 里的 suggest 包，安装时并没有指定 &ndash;no-suggest: 跳过扩展包建议，看来是默认不安装的</p><h4 id=2019-6-10>2019.6.10</h4><ul><li><p>laravel-s Redis::connection() 返回redis单例连接，每个 worker 进程只能保持一个连接，只有在max_request达到时
worker 将自动退出，进程退出后会释放所有内存和资源。</p></li><li><p>swoole yar 不兼容</p></li></ul><h4 id=2019-6-18-laravel-laravel-s-表单验证失败-不是ajax请求会302-然后-redirect-就会-404>2019.6.18 laravel laravel-s 表单验证失败，不是ajax请求会302，然后 redirect / 就会 404</h4><ol><li>重写 App\Exceptions\Handler::render 同一验证失败json输出</li><li>也可以重写request header 因为是非ajax才会302</li></ol><ul><li><p>laravel PhpRedisConnection hscan bug</p><pre><code class=language-php>$it = null;
$redis-&gt;setOption(\Redis::OPT_SCAN, \Redis::SCAN_RETRY);
while($device_fds = $redis-&gt;client()-&gt;hScan(Link::getFdMapKey(), $it, '', 1000)) {
    foreach($device_fds as $device_unique_mark =&gt; $fd) {
         echo $device_unique_mark . PHP_EOL;
    }
}
</code></pre><p>laravel框架封装的问题，需要调用$redis-&gt;client(),而不是直接使用phpredis，$it 需要引用，PhpRedisConnection 使用 __call 调用存在bug</p></li></ul><h4 id=2019-6-19-数组参数签名前-最好使用-ksort-排序>2019.6.19 数组参数签名前，最好使用 ksort 排序</h4><h4 id=2019-6-26-laravel-queue-redis-因为设置了-sleep-3-并且没有配置队列-block-for-导致队列延时执行>2019.6.26 laravel queue redis 因为设置了 &ndash;sleep=3 并且没有配置队列 block_for 导致队列延时执行</h4><p>删除了 &ndash;sleep=3 并且配置 block_for =&gt; 3
block_for：将任务重新放入 Redis 数据库以及处理器轮询之前阻塞多久</p><h4 id=2019-6-27-php-trait-定义了一个属性后-类就不能定义同样名称的属性-否则会产生-fatal-error-有种情况例外-属性是兼容的-同样的访问可见度-初始默认值>2019.6.27 php Trait 定义了一个属性后，类就不能定义同样名称的属性，否则会产生 fatal error。 有种情况例外：属性是兼容的（同样的访问可见度、初始默认值）</h4><p>可以先定义一个父类使用 Trait，然后子类就能覆写父类的属性了</p><h4 id=2019-7-1-可以为一个类提供一个静态方法-实例化自己-延迟绑定>2019.7.1 可以为一个类提供一个静态方法，实例化自己，延迟绑定</h4><pre><code class=language-php> public static function make($items = [])
 {
     return new static($items);
 }
</code></pre><h4 id=2019-7-8-mockery-mock>2019.7.8 Mockery::mock</h4><pre><code class=language-php>// 需先赋值
$request = Mockery::mock(CurlRequest::class);
// 这里不能连续调用，因为后面返回的不是 $request
$request-&gt;shouldReceive('post')
        -&gt;once()
        -&gt;andReturn([
            'status' =&gt; 1,
            'msg'    =&gt; '请求成功'
        ]);
</code></pre><h4 id=2019-7-11-小数精度问题>2019.7.11 小数精度问题</h4><pre><code class=language-php>echo 16.33 * 100; // 1633
echo intval(16.33 * 100); // 1632
echo intval(strval(16.33 * 100)); // 1633
echo (int)(16.33 * 100); // 1632
</code></pre><h4 id=2019-7-16-laravel-config-cache-的问题>2019.7.16 laravel config:cache 的问题</h4><p>如果在部署过程中执行 config:cache 命令，那你应该确保只从配置文件内部调用 env 函数。一旦配置被缓存，.env 文件将不再被加载，所有对 env 函数的调用都将返回 null</p><h4 id=2019-7-24-php-mb-strlen>2019.7.24 php mb_strlen</h4><pre><code class=language-php>echo mb_strlen('测试'); // 2 默认编码UTF-8
mb_strlen('测试', 'UTF-8'); // 2
mb_strlen('测试', '8bit'); // 6
strlen('测试'); // 6
// 8bit是php独有解析的, 8bit并不是一个字符集, 只是php引擎可以解析它而已. 顾名思义, 一个字节等于八个位, 1byte=8bit
</code></pre><p>PHP支持mbstring.func_overload, 用于解决原生substr无法有效应对多字节编码字符串问题
启用时php runtime状态是未知的， 所以在计算字符长度时， 用mb_strlen 8bit来保证计算字符串长度的正确性（按照1byte = 8bit）</p><h4 id=2019-7-25-php-一个if判断变量的速度问题-类型转换>2019.7.25 PHP 一个if判断变量的速度问题，类型转换</h4><pre><code class=language-php>$array = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

$start = microtime(true);
for ($i = 0; $i &lt; 1000000; $i++) {
//    if (count($array)) {} // 0.01805305480957
//    if (is_null($array)) {} // 0.013534784317017
//    if (empty($array)) {} // 0.014011859893799
    if (!$array) {} // 0.016890048980713
}
$end = microtime(true);
echo &quot;1: &quot; . ($end - $start) . &quot;\n&quot;;
echo memory_get_usage() . &quot;\n&quot;; // 389032
</code></pre><h4 id=2019-8-12-laravel-phpredis-subscribe-因为使用了redis前缀-channel-返回时需要去掉前缀>2019.8.12 laravel phpredis subscribe 因为使用了redis前缀 channel 返回时需要去掉前缀</h4><h4 id=2019-8-22-php多进程编程-pcntl-posix-event-发现grpc扩展会导致进程无法-kill-15>2019.8.22 php多进程编程，pcntl posix event，发现grpc扩展会导致进程无法 kill -15</h4><h4 id=2019-8-27-php-apcu扩展需要开启-apc-enable-cli-才能使用apcu-fetch之类的函数>2019.8.27 php apcu扩展需要开启 apc.enable_cli 才能使用apcu_fetch之类的函数</h4><h4 id=2019-8-28-php-composer-ignore-platform-reqs-可忽略平台约束-例如win下升级-而composer-json-require-一些win没有的扩展>2019.8.28 php composer &ndash;ignore-platform-reqs 可忽略平台约束 例如win下升级 而composer.json require 一些win没有的扩展</h4><h4 id=2019-10-11-http-https-代理解析协议端口时-需要解析-connect-host-的端口>2019.10.11 http https 代理解析协议端口时 需要解析 CONNECT HOST 的端口</h4><h4 id=2019-11-27-php-apcu-ttl-在cli下不过期的问题-需要设置apc-use-request-time-0>2019.11.27 php apcu ttl 在cli下不过期的问题，需要设置apc.use_request_time=0</h4><pre><code class=language-php>// cli 下运行
$bar = date('Y-m-d H:i:s');
var_dump(apcu_store('foo', $bar, 3));
sleep(4);
var_dump(apcu_fetch('foo'));
// apc.use_request_time=1 不过期
// 使用请求时间来淘汰缓存
</code></pre></div><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/mysql/>Mysql</a></li><li><a href=/linux/lock/>Lock</a></li><li><a href=/php/php7-array/>PHP7 Array</a></li><li><a href=/archives/>Archives</a></li><li><a href=/about/>About</a></li></ul></div><div class="post-meta meta-tags">没有标签</div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=wenjy/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://wenjy.top>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>分类</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>标签</h3><div class=tagcloud></div></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://mikelin.cn title="MIKELIN | 关注科技，弘扬互联网精神！">MIKELIN</a></li><li><a target=_blank href=https://wenjy.top title=江湖义气的网络日志>江湖义气的网络日志</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://wenjy.top/index.xml>文章 RSS</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2019 <a href=https://wenjy.top>Wenjy&#39;s Blog By 江湖义气</a>.
Powered by <a rel="nofollow noreferer noopener" href=https://gohugo.io target=_blank>Hugo</a>.
<a href=https://www.flysnow.org/ target=_blank>Theme</a> based on <a href=https://github.com/rujews/maupassant-hugo target=_blank>maupassant</a>.</div></footer><script type=text/javascript>(function(){$("pre code").parent().addClass("line-numbers")}());window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script type=text/javascript src=/js/prism.js async></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src="/js/totop.js?v=0.0.0" async></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script></body></html>